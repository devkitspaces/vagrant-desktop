# -*- mode: ruby -*-
# vi: set ft=ruby :
require 'getoptlong'
require 'yaml'

# ---------------------------------------
# Plugins
# ---------------------------------------
#if !Vagrant.has_plugin?('vagrant-vbguest')
#  puts 'vagrant-vbguest plugin required. To install simply do `vagrant plugin install vagrant-vbguest`'
#  abort
#end

# ---------------------------------------
# Header
# ---------------------------------------
Vagrant.require_version ">= 1.6.0"
VAGRANTFILE_API_VERSION = "2"

# 
# Parameters
# 
opts = GetoptLong.new(
    # Native vagrant options
     [ '--force', '-f', GetoptLong::NO_ARGUMENT ],
     [ '--provision', '-p', GetoptLong::NO_ARGUMENT ],
     [ '--provision-with', GetoptLong::NO_ARGUMENT ],
     [ '--provider', GetoptLong::OPTIONAL_ARGUMENT ],
     [ '--help', '-h', GetoptLong::NO_ARGUMENT ],
     [ '--check', GetoptLong::NO_ARGUMENT ],
     [ '--logout', GetoptLong::NO_ARGUMENT ],
     [ '--token', GetoptLong::NO_ARGUMENT ],
     [ '--disable-http', GetoptLong::NO_ARGUMENT ],
     [ '--http', GetoptLong::NO_ARGUMENT ],
     [ '--https', GetoptLong::NO_ARGUMENT ],
     [ '--ssh-no-password', GetoptLong::NO_ARGUMENT ],
     [ '--ssh', GetoptLong::NO_ARGUMENT ],
     [ '--ssh-port', GetoptLong::NO_ARGUMENT ],
     [ '--ssh-once', GetoptLong::NO_ARGUMENT ],
     [ '--host', GetoptLong::NO_ARGUMENT ],
     [ '--entry-point', GetoptLong::NO_ARGUMENT ],
     [ '--plugin-source', GetoptLong::NO_ARGUMENT ],
     [ '--plugin-version', GetoptLong::NO_ARGUMENT ],
     [ '--debug', GetoptLong::NO_ARGUMENT ],

    # Custom options
     [ '--env-file', GetoptLong::REQUIRED_ARGUMENT ]
)

envfile = {}
opts.each do |opt, arg|
  case opt
    when '--env-file'
      envfile=arg
  end
end

if envfile.nil? || envfile.empty?
  puts 'The --env-file argument is required.'
  puts 
  puts '  Usage: `vagrant --env-file=desktop.yaml up`'
  puts
  abort
end

# 
# Settings
# 
DIR_VAGRANT = File.expand_path(File.dirname(__FILE__))
env_filename = File.baseimage(envfile);
puts "reading environment file: #{env_filename}"
settings = {}
if !File.file?(envfile)
  puts "open #{envfile}: The system cannot find the file specified."
  puts "  path: #{envfile}"
  abort
end


settings = YAML.load_file(envfile)

name = settings['name']
if name.nil? || name.empty?
  puts 'The `name` property is required in the environment file: #{env_filename}.'
  abort
end

puts "HERE"
abort
# ---------------------------------------
# Definition
# ---------------------------------------

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  # 
  # Configuration
  #
  config.vm.box = "bento/ubuntu-16.04"
  config.vm.hostname = settings['name']
  config.ssh.forward_agent = true

  #
  # Shared Folders
  #
  config.vm.synced_folder "../", "/opt/vagrant"
  config.vm.synced_folder "../../../", "/home/vagrant/repositories"
  config.vm.provision "file", source: "#{envfile}", destination: "/tmp/envfile"

  # 
  # Virtualbox configuration
  #
  config.vm.provider :virtualbox do |vb|
    vb.gui = true

    vb.name = settings['name']

    vb.customize ["modifyvm", :id, "--cpus", "2"]
    vb.customize ["modifyvm", :id, "--memory", "2048"]
    vb.customize ["modifyvm", :id, "--graphicscontroller", "vboxvga"]
    vb.customize ["modifyvm", :id, "--vram", "128"]

    vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
    vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    vb.customize ["modifyvm", :id, "--ioapic", "on"]
  end

  # Prevent TTY Errors (copied from laravel/homestead: "homestead.rb" file)... By default this is "bash -l".
  config.ssh.shell = "bash -c 'BASH_ENV=/etc/profile exec bash'"
  
  # ---------------------------------------
  # Provisioning
  # ---------------------------------------  
  config.vm.provision "shell", inline: "echo #{settings['name']} is #{settings['desktop']} environment"
  config.vm.provision :shell, :path => File.join( "packaging", "bootstrap.sh" )
  
  # provison-pre.sh
  #
  # provison-pre.sh acts as a pre-hook to the default provisioning script.
  #if File.exists?(File.join(VAGRANT_DIR,'provision','provision-pre.sh')) then
  #  config.vm.provision :shell, :path => File.join( "provision", "provision-pre.sh" )
  #end

  # prepare.sh
  #
  # prepare.sh prepares the desktop environment for provisioning by setting up essential components.
  #config.vm.provision :shell, :path => File.join( "packaging", "prepare.sh" )

  # environments
  #
  # The environments scripts provision a desktop environment based on the provided `VM_DESKTOP` parameter.
  #config.vm.provision :shell, :path => File.join( "packaging", "environments", "#{settings['VM_DESKTOP']}.sh" )

  # provision.sh
  #
  # prepare.sh provisions the environment.
  #if File.exists?(File.join(VAGRANT_DIR,'provision','provision.sh')) then
  #  config.vm.provision :shell, :path => File.join( "provision", "provision.sh" )
  #end

  # provision-post.sh
  #
  # provison-pre.sh acts as a post-hook to the default provisioning script.
  #if File.exists?(File.join(VAGRANT_DIR,'provision','provision-post.sh')) then
  #  config.vm.provision :shell, :path => File.join( "provision", "provision-post.sh" )
  #end

  #
  # End of Provision
  # 
  config.vm.provision :shell, inline: "echo \"\n \nThe #{settings['name']} is ready!\nYou should reboot the environment to ensure everything is in working order.\n \n \n\""
end